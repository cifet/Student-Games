<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Space Invaders Ultimate</title>

<style>
    body {
        margin: 0;
        background: black;
        overflow: hidden;
    }
    canvas {
        display: block;
        margin: 0 auto;
        image-rendering: pixelated;
        filter: contrast(1.2) brightness(1.1);
    }
    #resetBtn {
        position: fixed;
        top: 10px;
        right: 10px;
        padding: 8px 12px;
        font-size: 18px;
    }
    body:after {
        content: "";
        pointer-events: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: repeating-linear-gradient(
            transparent 0px,
            rgba(0, 0, 0, 0.2) 2px,
            transparent 4px
        );
        mix-blend-mode: overlay;
        opacity: 0.25;
    }
</style>
</head>

<body>

<button id="resetBtn">Reset Game</button>
<canvas id="game" width="640" height="640"></canvas>

<script>
/* =====================================================
   CORE SETUP 
===================================================== */
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const W = canvas.width;
const H = canvas.height;

/* GAME STATE */
let STATE = "TITLE";
let keys = {};

let player;
let bullets = [];
let enemyBullets = [];
let enemies = [];
let boss = null;
let powerups = [];

let wave = 1;
let score = 0;
let highScore = localStorage.getItem("invadersHighScore") || 0;

let enemyDirection = 1;
let enemySpeed = 1;
let enemyDrop = 20;

/* Powerups */
let rapidFire = false;
let rapidTimer = 0;
let bigShot = false;
let bigShotTimer = 0;
let shield = false;

let shootCooldown = 0;

/* =====================================================
   RESET FUNCTIONS
===================================================== */
function resetPlayer() {
    player = {
        x: W/2 - 20,
        y: H - 80,
        width: 40,
        height: 30,
        speed: 6
    };
}

function resetGame() {
    bullets = [];
    enemyBullets = [];
    enemies = [];
    boss = null;
    powerups = [];

    rapidFire = false;
    bigShot = false;
    shield = false;

    rapidTimer = 0;
    bigShotTimer = 0;

    wave = 1;
    score = 0;

    resetPlayer();
    createWave();
    STATE = "PLAYING";
}

document.getElementById("resetBtn").onclick = resetGame;

/* =====================================================
   CREATE WAVES
===================================================== */
function createWave() {
    enemies = [];
    enemyBullets = [];
    boss = null;

    if (wave === 6) {
        STATE = "YOUWIN";
        return;
    }

    if (wave === 5) {
        boss = {
            x: W/2 - 80,
            y: 60,
            width: 160,
            height: 80,
            hp: 40,
            maxHp: 40,
            speed: 2,
            direction: 1,
            shootTimer: 0
        };
        return;
    }

    const rows = 3 + wave;
    const cols = 6 + wave;
    enemySpeed = 1 + wave * 0.3;

    for (let r = 0; r < rows; r++) {
        for (let c = 0; c < cols; c++) {
            enemies.push({
                x: 60 + c * 50,
                y: 60 + r * 40,
                size: 26,
                alive: true,
                explosion: 0,
                shootTimer: 0
            });
        }
    }
}

/* =====================================================
   SHOOTING
===================================================== */
function shoot() {
    if (shootCooldown > 0) return;

    let size = bigShot ? 10 : 4;

    bullets.push({
        x: player.x + player.width/2 - size/2,
        y: player.y,
        width: size,
        height: 14,
        speed: 8
    });

    shootCooldown = rapidFire ? 8 : 20;
}

/* =====================================================
   COLLISION
===================================================== */
function rectRect(a,b) {
    return (
        a.x < b.x + b.width &&
        a.x + a.width > b.x &&
        a.y < b.y + b.height &&
        a.y + a.height > b.y
    );
}

function rectTri(b, e) {
    return (
        b.x < e.x + e.size &&
        b.x + b.width > e.x &&
        b.y < e.y + e.size &&
        b.y + b.height > e.y
    );
}

/* =====================================================
   UPDATE LOOP
===================================================== */
function update() {
    if (STATE !== "PLAYING") return;

    /* Player movement */
    if (keys["ArrowLeft"] && player.x > 0) player.x -= player.speed;
    if (keys["ArrowRight"] && player.x + player.width < W) player.x += player.speed;

    /* Timers */
    if (rapidFire && --rapidTimer <= 0) rapidFire = false;
    if (bigShot && --bigShotTimer <= 0) bigShot = false;
    if (shootCooldown > 0) shootCooldown--;

    /* Move bullets */
    for (let b of bullets) b.y -= b.speed;
    bullets = bullets.filter(b => b.y > -20);

    for (let eb of enemyBullets) eb.y += eb.speed;
    enemyBullets = enemyBullets.filter(eb => eb.y < H + 30);

    /* =====================================================
        BOSS LOGIC (with slower shooting)
    ====================================================== */
    if (boss) {
        boss.x += boss.speed * boss.direction;

        if (boss.x < 20 || boss.x + boss.width > W - 20) {
            boss.direction *= -1;
            boss.y += 20;
        }

        if (++boss.shootTimer > 90) {   // slower boss shots
            boss.shootTimer = 0;
            enemyBullets.push({
                x: boss.x + boss.width/2,
                y: boss.y + boss.height,
                width: 6,
                height: 12,
                speed: 4
            });
        }

        for (let b of bullets) {
            if (rectRect(b, boss)) {
                boss.hp--;
                b.y = -999;
                score += 3;

                if (boss.hp <= 0) {
                    boss = null;
                    wave++;
                    createWave();
                }
            }
        }

        if (boss.y + boss.height >= player.y) STATE = "GAMEOVER";
        return;
    }

    /* =====================================================
        NORMAL ENEMY WAVE (slower shooting)
    ====================================================== */

    let hitEdge = false;

    for (let e of enemies) {
        if (!e.alive) continue;

        e.x += enemySpeed * enemyDirection;

        if (e.x < 20 || e.x + e.size > W - 20) hitEdge = true;

        if (wave >= 2) {
            e.shootTimer++;
            if (e.shootTimer > 150 + Math.random()*150) {  // MUCH slower shots
                e.shootTimer = 0;
                enemyBullets.push({
                    x: e.x + e.size/2,
                    y: e.y + e.size,
                    width: 4,
                    height: 10,
                    speed: 4
                });
            }
        }
    }

    if (hitEdge) {
        enemyDirection *= -1;
        for (let e of enemies) e.y += enemyDrop;
    }

    /* Bullet hits enemy */
    for (let b of bullets) {
        for (let e of enemies) {
            if (e.alive && rectTri(b, e)) {
                e.alive = false;
                e.explosion = 8;
                b.y = -999;
                score += 10;

                if (wave <= 3 && Math.random() < 0.2) {
                    let type = ["rapid","shield","big"][Math.floor(Math.random()*3)];
                    powerups.push({
                        x: e.x,
                        y: e.y,
                        size: 16,
                        type: type,
                        speed: 2
                    });
                }
            }
        }
    }

    /* Enemy bullet hits player */
    for (let eb of enemyBullets) {
        if (rectRect(eb, player)) {
            if (shield) {
                shield = false;
                eb.y = 999;
            } else {
                STATE = "GAMEOVER";
            }
        }
    }

    /* Powerups */
    for (let p of powerups) {
        p.y += p.speed;
        if (rectRect(p, player)) {
            if (p.type === "rapid") { rapidFire = true; rapidTimer = 300; }
            if (p.type === "shield") { shield = true; }
            if (p.type === "big") { bigShot = true; bigShotTimer = 300; }
            p.y = 999;
        }
    }

    powerups = powerups.filter(p => p.y < H + 20);

    /* Enemy reaches player */
    for (let e of enemies) {
        if (e.alive && e.y + e.size >= player.y) STATE = "GAMEOVER";
    }

    /* Wave cleared */
    if (enemies.every(e => !e.alive)) {
        wave++;
        createWave();
    }

    if (score > highScore) {
        localStorage.setItem("invadersHighScore", score);
    }
}

/* =====================================================
   DRAW FUNCTIONS
===================================================== */
function drawPlayer() {
    ctx.fillStyle = shield ? "cyan" : "white";

    ctx.beginPath();
    ctx.moveTo(player.x + player.width/2, player.y);              // Nose
    ctx.lineTo(player.x, player.y + player.height);               // Left wing
    ctx.lineTo(player.x + player.width, player.y + player.height); // Right wing
    ctx.closePath();
    ctx.fill();
}

function drawBullet(b) {
    ctx.fillStyle = "yellow";
    ctx.fillRect(b.x, b.y, b.width, b.height);
}

function drawEnemy(e) {
    ctx.fillStyle = "lime";
    ctx.beginPath();
    ctx.moveTo(e.x + e.size/2, e.y);
    ctx.lineTo(e.x, e.y + e.size);
    ctx.lineTo(e.x + e.size, e.y + e.size);
    ctx.fill();
}

function drawExplosion(e) {
    ctx.fillStyle = "red";
    ctx.beginPath();
    ctx.arc(e.x + 13, e.y + 13, 20 - e.explosion*2, 0, Math.PI * 2);
    ctx.fill();
    e.explosion--;
}

function drawBoss(b) {
    ctx.fillStyle = "purple";
    ctx.fillRect(b.x, b.y, b.width, b.height);

    ctx.fillStyle = "red";
    ctx.fillRect(b.x, b.y - 20, b.width, 10);

    ctx.fillStyle = "lime";
    ctx.fillRect(b.x, b.y - 20, (b.hp / b.maxHp) * b.width, 10);
}

function drawPowerup(p) {
    ctx.fillStyle =
        p.type === "rapid" ? "orange" :
        p.type === "shield" ? "cyan" :
        "magenta";

    ctx.fillRect(p.x, p.y, p.size, p.size);
}

function drawEnemyBullet(eb) {
    ctx.fillStyle = "red";
    ctx.fillRect(eb.x, eb.y, eb.width, eb.height);
}

function drawHUD() {
    ctx.fillStyle = "white";
    ctx.font = "24px monospace";
    ctx.fillText("Score: " + score, 20, 30);
    ctx.fillText("High: " + highScore, 20, 60);
    ctx.fillText("Wave: " + wave, W - 140, 30);
}

/* =====================================================
   MAIN DRAW LOOP
===================================================== */
function draw() {
    ctx.clearRect(0, 0, W, H);

    if (STATE === "TITLE") {
        ctx.fillStyle = "white";
        ctx.font = "64px monospace";
        ctx.fillText("SPACE INVADERS", W/2 - 260, H/2 - 40);

        ctx.font = "28px monospace";
        ctx.fillStyle = "yellow";
        ctx.fillText("PRESS ENTER TO START", W/2 - 200, H/2 + 40);
        return;
    }

    if (STATE === "YOUWIN") {
        ctx.fillStyle = "yellow";
        ctx.font = "64px monospace";
        ctx.fillText("YOU WIN!", W/2 - 150, H/2 - 20);
        ctx.font = "28px monospace";
        ctx.fillText("PRESS ENTER TO RESTART", W/2 - 200, H/2 + 60);
        return;
    }

    if (STATE === "GAMEOVER") {
        ctx.fillStyle = "red";
        ctx.font = "64px monospace";
        ctx.fillText("GAME OVER", W/2 - 180, H/2 - 20);

        ctx.font = "28px monospace";
        ctx.fillStyle = "white";
        ctx.fillText("PRESS ENTER TO RESTART", W/2 - 200, H/2 + 60);
        return;
    }

    drawPlayer();

    for (let b of bullets) drawBullet(b);
    for (let eb of enemyBullets) drawEnemyBullet(eb);

    if (boss) drawBoss(boss);
    else {
        for (let e of enemies) {
            if (e.alive) drawEnemy(e);
            else if (e.explosion > 0) drawExplosion(e);
        }
    }

    for (let p of powerups) drawPowerup(p);

    drawHUD();
}

/* =====================================================
   GAME LOOP
===================================================== */
function loop() {
    update();
    draw();
    requestAnimationFrame(loop);
}

/* =====================================================
   INPUT
===================================================== */
document.addEventListener("keydown", e => {
    keys[e.key] = true;

    if (STATE === "TITLE" && e.key === "Enter") resetGame();
    if (STATE === "GAMEOVER" && e.key === "Enter") resetGame();
    if (STATE === "YOUWIN" && e.key === "Enter") resetGame();

    if (STATE === "PLAYING") {
        if (e.key === " " || e.key === "ArrowUp") shoot();
    }
});

document.addEventListener("keyup", e => {
    keys[e.key] = false;
});

/* =====================================================
   START
===================================================== */
loop();
</script>
</body>
</html>



